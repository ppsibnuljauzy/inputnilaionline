<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>Aplikasi Input Nilai</title>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<!-- Excel -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<style>
body{margin:0;font-family:Arial;background:#0f172a;color:#e5e7eb}
nav{background:#020617;padding:10px;display:flex;gap:8px}
nav button{background:#1e293b;color:#fff;border:0;padding:8px 14px;cursor:pointer}
nav button:hover, nav button.active{background:#475569}
.tab{display:none;padding:20px}
.tab.active{display:block}
input,select{padding:6px;margin:4px}
table{border-collapse:collapse;width:100%}
th,td{border:1px solid #334155;padding:6px;text-align:center}
</style>
</head>

<body>
<div id="loading" style="padding:20px">‚è≥ Memuat aplikasi...</div>

<nav id="nav"></nav>

<div id="uh" class="tab">
<h3>Input Nilai UH</h3>
<select id="uhMapel"></select>
<select id="uhSiswa"></select>
<input id="uhNilai" type="number" placeholder="Nilai">
<button onclick="simpan('UH')">Simpan</button>
</div>

<div id="pts" class="tab">
<h3>Input Nilai PTS</h3>
<select id="ptsMapel"></select>
<select id="ptsSiswa"></select>
<input id="ptsNilai" type="number" placeholder="Nilai">
<button onclick="simpan('PTS')">Simpan</button>
</div>

<div id="pas" class="tab">
<h3>Input Nilai PAS</h3>
<select id="pasJenis">
<option value="PAS_LISAN">PAS Lisan</option>
<option value="PAS_TULIS">PAS Tulis</option>
<option value="PAS_PRAKTEK">PAS Praktek</option>
</select>
<select id="pasMapel"></select>
<select id="pasSiswa"></select>
<input id="pasNilai" type="number" placeholder="Nilai">
<button onclick="simpanPAS()">Simpan</button>
</div>

<div id="siswa" class="tab">
<h3>Import Siswa (Excel)</h3>
<input type="file" onchange="importSiswa(event)">
</div>

<div id="rekap" class="tab">
<h3>Rekap Nilai</h3>
<table>
<thead>
<tr>
<th>Siswa</th><th>Mapel</th><th>UH</th><th>PTS</th>
<th>PL</th><th>PT</th><th>PP</th><th>NA</th>
</tr>
</thead>
<tbody id="rekapBody"></tbody>
</table>
</div>

<script>
// ================= FIREBASE =================
firebase.initializeApp({
  apiKey: "AIzaSyBJORnW-C8I-_pq0Ikg4HlgEQN3ZKJiG4s",
  authDomain: "input-nilai-3.firebaseapp.com",
  projectId: "input-nilai-3",
});

const auth = firebase.auth();
const db = firebase.firestore();
let currentUser, guruMapel = [];

// ================= LOGIN =================
auth.onAuthStateChanged(async user => {
  if(!user){
    loading.innerText = 'üîê Login Google...';
    auth.signInWithRedirect(new firebase.auth.GoogleAuthProvider());
    return;
  }

  currentUser = user;

  try {
    const g = await db.collection('guru').doc(user.email).get();
    if(!g.exists){
      loading.innerHTML = `
        <h3>‚ùå Akses ditolak</h3>
        <p>Email Anda belum terdaftar sebagai guru.</p>
      `;
      return;
    }

    guruMapel = g.data().mapel || [];
    buildMenu();
    await loadSiswa();
    loading.remove();
    show('uh'); // tampilkan tab UH pertama kali
  } catch(err) {
    loading.innerHTML = `<h3>‚ùå Error:</h3><pre>${err}</pre>`;
    console.error(err);
  }
});

// ================= MENU =================
function buildMenu(){
  nav.innerHTML = '';
  addBtn('UH','uh');
  addBtn('PTS','pts');
  addBtn('PAS','pas');
  addBtn('Siswa','siswa');
  addBtn('Rekap','rekap');
}
function addBtn(t,id){
  let b = document.createElement('button');
  b.textContent = t;
  b.onclick = () => {
    show(id);
    document.querySelectorAll('nav button').forEach(btn=>btn.classList.remove('active'));
    b.classList.add('active');
  }
  nav.appendChild(b);
}
function show(id){
  document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
  document.getElementById(id).classList.add('active');
  if(id==='rekap') loadRekap();
}

// ================= SISWA =================
async function loadSiswa(){
  const snap = await db.collection('siswa').get();
  ['uhSiswa','ptsSiswa','pasSiswa'].forEach(id=>document.getElementById(id).innerHTML='');
  snap.forEach(d=>{
    ['uhSiswa','ptsSiswa','pasSiswa'].forEach(id=>{
      let o = document.createElement('option');
      o.value = d.id; o.text = d.data().nama;
      document.getElementById(id).appendChild(o);
    });
  });
  ['uhMapel','ptsMapel','pasMapel'].forEach(id=>{
    document.getElementById(id).innerHTML='';
    guruMapel.forEach(m=>{
      let o = document.createElement('option');
      o.value = m; o.text = m;
      document.getElementById(id).appendChild(o);
    });
  });
}

// ================= SIMPAN =================
async function simpan(jenis){
  const mapel = document.getElementById(jenis.toLowerCase()+'Mapel').value;
  const siswaId = document.getElementById(jenis.toLowerCase()+'Siswa').value;
  const nilai = Number(document.getElementById(jenis.toLowerCase()+'Nilai').value);
  await db.collection('nilai').add({jenis,mapel,siswaId,nilai});
  await hitungRekap(siswaId,mapel);
}

async function simpanPAS(){
  const jenis = pasJenis.value;
  const mapel = pasMapel.value;
  const siswaId = pasSiswa.value;
  const nilai = Number(pasNilai.value);
  await db.collection('nilai').add({jenis,mapel,siswaId,nilai});
  await hitungRekap(siswaId,mapel);
}

// ================= IMPORT SISWA =================
async function importSiswa(e){
  const wb = XLSX.read(await e.target.files[0].arrayBuffer());
  const data = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
  for(let s of data){
    await db.collection('siswa').add({
      nisn: s.NISN || s.nisn,
      nama: s.NAMA || s.nama,
      kelas: s.KELAS || s.kelas
    });
  }
  alert('Import selesai');
  await loadSiswa();
}

// ================= REKAP =================
async function hitungRekap(siswaId,mapel){
  const q = await db.collection('nilai').where('siswaId','==',siswaId).where('mapel','==',mapel).get();
  let r = {UH:0,PTS:0,PAS_LISAN:0,PAS_TULIS:0,PAS_PRAKTEK:0};
  q.forEach(d=>r[d.data().jenis] = d.data().nilai || 0);
  let pas = (r.PAS_LISAN + r.PAS_TULIS + r.PAS_PRAKTEK)/3;
  let na = (r.UH*0.2)+(r.PTS*0.3)+(pas*0.5);
  await db.collection('rekap').doc(siswaId+'_'+mapel).set({
    UH: r.UH,
    PTS: r.PTS,
    PAS_LISAN: r.PAS_LISAN,
    PAS_TULIS: r.PAS_TULIS,
    PAS_PRAKTEK: r.PAS_PRAKTEK,
    na: na,
    mapel: mapel,
    siswaId: siswaId
  });
}

async function loadRekap(){
  rekapBody.innerHTML='';
  const siswaSnap = await db.collection('siswa').get();
  let sm = {}; siswaSnap.forEach(d=>sm[d.id]=d.data().nama);
  const snap = await db.collection('rekap').get();
  snap.forEach(d=>{
    let r = d.data();
    rekapBody.innerHTML += `
    <tr>
      <td>${sm[r.siswaId]}</td>
      <td>${r.mapel}</td>
      <td>${r.UH}</td>
      <td>${r.PTS}</td>
      <td>${r.PAS_LISAN}</td>
      <td>${r.PAS_TULIS}</td>
      <td>${r.PAS_PRAKTEK}</td>
      <td><b>${r.na.toFixed(1)}</b></td>
    </tr>`;
  });
}
</script>

</body>
</html>
