<!doctype html>
<html lang="id">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Aplikasi Input Nilai â€” Firestore (Mobile Friendly)</title>
<style>
/* =========================
   ROOT THEME
========================= */
:root {
  --bg: #f8fafc;
  --card: #ffffff;

  --primary: #06b6d4;
  --primary-dark: #0284c7;
  --primary-soft: #e0f7ff;

  --danger: #ef4444;
  --danger-dark: #dc2626;

  --muted: #64748b;

  --radius: 16px;
  --radius-sm: 10px;

  --shadow-sm: 0 2px 6px rgba(0,0,0,.06);
  --shadow-md: 0 8px 24px rgba(0,0,0,.08);
}

/* =========================
   GLOBAL RESET
========================= */
* {
  box-sizing: border-box;
  font-family: Inter, ui-sans-serif, system-ui, -apple-system,
    "Segoe UI", Roboto, "Helvetica Neue", Arial;
  transition: background-color .2s ease,
              color .2s ease,
              box-shadow .2s ease,
              transform .2s ease;
}

body {
  margin: 0;
  background: linear-gradient(180deg,#f0f4f8,#ffffff);
  color: #222;
  font-size: 15px;
}

h1 {
  margin: 0;
  font-size: 20px;
  font-weight: 800;
  background: linear-gradient(135deg,var(--primary-dark),var(--primary));
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
}

.container {
  max-width: 1100px;
  margin: 0 auto;
  padding: 0 16px;
}

/* =========================
   HEADER
========================= */
header {
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-bottom:16px;
  flex-wrap:wrap;
  gap:8px;
}

.auth-area {
  display:flex;
  gap:8px;
  align-items:center;
  flex-wrap:wrap;
  justify-content:flex-end;
}

/* =========================
   CARD & PANEL (SOFT BORDER)
========================= */
.card,
.panel {
  background: var(--card);
  border-radius: var(--radius);
  padding: 16px;
  border:1px solid rgba(0,0,0,.06);
  box-shadow:
    0 1px 2px rgba(0,0,0,.04),
    0 8px 24px rgba(0,0,0,.06);
}

.panel {
  background: linear-gradient(180deg,#ffffff,#f8fafc);
}

.panel:hover {
  transform: translateY(-2px);
  box-shadow: var(--shadow-md);
}

/* =========================
   TABS (SMOOTH & ELEGANT)
========================= */
.tabs {
  display:flex;
  gap:6px;
  padding:6px;
  background:linear-gradient(180deg,#e0f2fe,#f0f9ff);
  border-radius:16px;
  border:1px solid rgba(6,182,212,.25);
  box-shadow: inset 0 1px 2px rgba(255,255,255,.6);
  overflow-x:auto;
  margin-bottom:12px;
}

.tab {
  padding:8px 16px;
  border-radius:14px;
  cursor:pointer;
  font-weight:600;
  color:var(--primary-dark);
  background:rgba(255,255,255,.6);
  border:1px solid rgba(6,182,212,.15);
  white-space:nowrap;
  backdrop-filter: blur(4px);
transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

.tab:hover {
  background:var(--primary-soft);
  border-color:rgba(6,182,212,.35);
}

.tab.active {
  background:linear-gradient(135deg,var(--primary),var(--primary-dark));
  color:#fff;
  border-color:transparent;
  box-shadow:0 6px 16px rgba(6,182,212,.45);
transform: scale(1.05); /* Sedikit membesar saat aktif agar terasa interaktif */
}

/* =========================
   GRID
========================= */
.grid {
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:16px;
  justify-items:center;
}

/* =========================
   FORM
========================= */
label {
  display:block;
  font-size:13px;
  color:var(--muted);
  margin-bottom:6px;
}

input[type=text],
input[type=number],
select {
  width:100%;
  padding:10px;
  border-radius:var(--radius-sm);
  border:1px solid #ccc;
}

input:focus,
select:focus {
  outline:none;
  border-color:var(--primary);
  box-shadow:0 0 0 3px rgba(6,182,212,.25);
}

/* =========================
   BUTTON SYSTEM
========================= */
.btn {
  display:inline-flex;
  align-items:center;
  justify-content:center;
  padding:10px 16px;
  border-radius:var(--radius-sm);
  border:none;
  cursor:pointer;
  font-weight:600;
  color:#fff;
  background:linear-gradient(135deg,var(--primary),var(--primary-dark));
  box-shadow:0 4px 12px rgba(6,182,212,.35);
}

.btn:hover {
  transform:translateY(-1px);
  box-shadow:0 6px 16px rgba(6,182,212,.45);
}

.btn.small {
  padding:6px 12px;
  font-size:13px;
}

/* EDIT */
.btn.edit,
.btnEdit,
.btnEditTx {
  background:linear-gradient(135deg,var(--primary),var(--primary-dark));
  border:1px solid var(--primary-dark);
}

/* DELETE NORMAL */
.btn.delete,
.btnDel,
.btnDelTx {
  background:linear-gradient(135deg,var(--danger),var(--danger-dark));
  border:1px solid var(--danger-dark);
  box-shadow:0 3px 10px rgba(239,68,68,.35);
}

/* DELETE ALL (SUPER RED) */
.btn.delete-all,
.btn.hapus-semua {
  background: linear-gradient(135deg,#ff4d4f,#dc2626);
  border: 1px solid #b91c1c;
  box-shadow:0 6px 18px rgba(239,68,68,.45);
}

.btn.delete-all:hover,
.btn.hapus-semua:hover {
  background: linear-gradient(135deg,#dc2626,#b91c1c);
  transform:translateY(-1px) scale(1.02);
  box-shadow:0 8px 24px rgba(239,68,68,.55);
}

/* GHOST */
.btn.ghost {
  background:#f1f5f9;
  color:var(--muted);
  box-shadow:none;
  border:1px solid #cbd5e1;
}

.btn.ghost:hover {
  background:var(--primary);
  color:#fff;
  border-color:var(--primary-dark);
}

/* =========================
   SANTRI LIST
========================= */
.santri-list {
  max-height:380px;
  overflow:auto;
  margin-top:10px;
  padding:8px;
  border-radius:12px;
  border:1px dashed rgba(0,0,0,.1);
  background:#fafafa;
}

.santri-row {
  display:flex;
  gap:12px;
  align-items:center;
  padding:8px;
  border-radius:10px;
}

.santri-row:nth-child(odd) {
  background:rgba(0,0,0,.02);
}

.santri-row:hover {
  background:var(--primary-soft);
}

/* =========================
   TABLE (SMOOTH & MODERN)
========================= */
.transactions {
  margin-top:12px;
  overflow-x:auto;
  border-radius:14px;
  border:1px solid rgba(0,0,0,.06);
  box-shadow: var(--shadow-sm);
}

table {
  width:100%;
  border-collapse:separate;
  border-spacing:0;
  border-radius:14px;
  overflow:hidden;
}

th, td {
  padding:10px 12px;
  font-size:13px;
  border-bottom:1px solid rgba(0,0,0,.05);
}

th {
  background:linear-gradient(180deg,#f8fafc,#f1f5f9);
  color:var(--muted);
  font-weight:700;
}

tbody tr:last-child td {
  border-bottom:none;
}

tbody tr:hover {
  background:rgba(6,182,212,.08);
}

/* =========================
   RESPONSIVE
========================= */
@media(max-width:900px){
  .grid {
    grid-template-columns:1fr;
  }
  .panel {
    width:100%;
  }
}

@media(max-width:600px){
  body { font-size:14px; padding:12px; }
  h1 { font-size:18px; }

  table, thead, tbody, th, td, tr {
    display:block;
    width:100%;
  }

  thead { display:none; }

  tr {
    margin-bottom:10px;
    border-bottom:1px solid rgba(0,0,0,.1);
  }

  td {
    display:flex;
    justify-content:space-between;
    padding:6px 8px;
  }

  td::before {
    content:attr(data-label);
    font-weight:600;
    color:var(--muted);
  }
}

button:disabled {
  opacity:.5;
  cursor:not-allowed;
}
.table-responsive {
  display: block;
  width: 100%;
  overflow-x: auto;
  -webkit-overflow-scrolling: touch;
}
.badge {
  background: var(--primary-soft);
  color: var(--primary-dark);
  padding: 2px 8px;
  border-radius: 8px;
  font-size: 11px;
  font-weight: 600;
  text-transform: uppercase;
}
input[type="number"] {
  font-size: 16px; /* Mencegah auto-zoom di iOS Safari */
  -moz-appearance: textfield;
}
input::-webkit-outer-spin-button,
input::-webkit-inner-spin-button {
  -webkit-appearance: none;
  margin: 0;
}
.btn.edit {
  background: linear-gradient(135deg, #f59e0b, #d97706); /* Warna Oranye/Amber */
  border: 1px solid #b45309;
  box-shadow: 0 3px 10px rgba(245, 158, 11, 0.3);
  margin-right: 4px; /* Memberi jarak dengan tombol hapus */
}

.btn.edit:hover {
  background: linear-gradient(135deg, #d97706, #b45309);
  transform: translateY(-1px);
}
/* Animasi konten masuk */
@keyframes fadeIn {
  from { 
    opacity: 0; 
    transform: translateY(10px); 
  }
  to { 
    opacity: 1; 
    transform: translateY(0); 
  }
}

#mainPanel {
  animation: fadeIn 0.4s ease-out;
  /* Memastikan transisi smooth saat tinggi panel berubah */
  transition: all 0.3s ease;
}
/* Efek saat tombol ditekan */
.btn:active, .tab:active {
  transform: scale(0.95);
  filter: brightness(0.9);
}

/* Membuat scrollbar di tab mobile lebih halus */
.tabs {
  scroll-behavior: smooth;
  -webkit-overflow-scrolling: touch;
}

/* Menghilangkan scrollbar tapi tetap bisa di-scroll (opsional agar bersih) */
.tabs::-webkit-scrollbar {
  display: none;
}
.tabs {
  -ms-overflow-style: none;  /* IE and Edge */
  scrollbar-width: none;  /* Firefox */
}
/* Animasi Putar */
@keyframes spin {
  to { transform: rotate(360deg); }
}

.spinner {
  width: 18px;
  height: 18px;
  border: 3px solid rgba(255,255,255,0.3);
  border-radius: 50%;
  border-top-color: #fff;
  animation: spin 0.8s linear infinite;
  margin-right: 10px;
  display: inline-block;
  vertical-align: middle;
}

/* State tombol saat loading */
.btn-loading {
  pointer-events: none; /* Mencegah klik ganda */
  opacity: 0.8;
}
.badge-uh { background: #dcfce7; color: #166534; }
.badge-pts { background: #fef9c3; color: #854d0e; }
.badge-pas { background: #dbeafe; color: #1e40af; }
.input-score.error {
  border: 2px solid var(--danger) !important;
  background-color: #fff1f2;
}
/* Secara default tetap tampil */
.tab { display: block; }

/* Sembunyikan Tab Khusus Admin */
body.role-user .tab[data-tab="DAFTAR_SANTRI"],
body.role-user .tab[data-tab="DAFTAR_MAPEL"],
body.role-user .tab[data-tab="DAFTAR_GURU"],
body.role-user .tab[data-tab="REKAP_SISWA"] {
  display: none;
}

/* Sembunyikan Panel Kanan (Tabel Transaksi) untuk User */
body.role-user .grid {
  grid-template-columns: 1fr; /* Ubah grid menjadi 1 kolom penuh */
}

body.role-user .grid > .panel:nth-child(2) {
  display: none; /* Sembunyikan panel kedua (tabel transaksi) */
}
</style>
</head>
<body>
<div class="container">
  <header>
    <h1>Aplikasi Input Nilai â€” UH / PTS / PAS</h1>
    <div class="auth-area">
      <div id="userLabel">Offline</div>
      <button class="btn small" id="btnLogin">Masukkan PIN Akses</button>
      <button class="btn small ghost" id="btnLogout" style="display:none">Logout</button>
    </div>
  </header>

  <div class="card">
    <div class="tabs" id="tabs">
      <div class="tab active" data-tab="UH">INPUT UH</div>
      <div class="tab" data-tab="PTS">INPUT PTS</div>
      <div class="tab" data-tab="PAS">INPUT PAS</div>
      <div class="tab" data-tab="DAFTAR_SANTRI">DAFTAR SANTRI</div>
      <div class="tab" data-tab="DAFTAR_MAPEL">DAFTAR MAPEL</div>
      <div class="tab" data-tab="DAFTAR_GURU">DAFTAR GURU</div>
      <div class="tab" data-tab="REKAP_SISWA">REKAP PERSISWA</div>
    </div>

    <div class="grid">
      <div class="panel" id="mainPanel"></div>


      <!-- PANEL TABEL -->
      <div class="panel" style="overflow:auto;">
        <h3 style="margin-top:0">Tabel Transaksi Nilai</h3>
        <div id="transactionsFilter"></div>
        <div class="transactions card" id="transactionsPanel"></div>
        <div class="footer-note">Data transaksi berisi semua nilai UH, PTS, PAS. Bisa edit/hapus. Disimpan di Firestore.</div>
      </div>
    </div>
  </div>

  <div style="height:18px"></div>
  <div style="color:var(--muted);font-size:13px">
    Tips: Gunakan tab <strong>DAFTAR SANTRI</strong> dan <strong>DAFTAR MAPEL</strong> untuk meng-custom nama santri & mapel. Perubahan langsung mempengaruhi dropdown dan daftar di tab nilai.
  </div>
</div>

<!-- Modal Preview Nilai -->
<div id="previewModal" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);justify-content:center;align-items:center;z-index:9999;">
  <div style="background:#fff;padding:16px;border-radius:12px;max-width:90%;max-height:80%;overflow:auto;position:relative;">
    <button id="closePreview" style="position:absolute;top:8px;right:8px;padding:4px 8px;border:none;background:#f00;color:#fff;border-radius:6px;cursor:pointer;">âœ•</button>
    <div id="previewContent"></div>
  </div>
</div>

<!-- SheetJS for Excel parsing -->
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>

<script type="module">
let currentPage = 1;
const rowsPerPage = 10; // Jumlah data per halaman
// ====== FIREBASE INIT ======
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
import { getFirestore, collection, doc, addDoc, getDocs, updateDoc, deleteDoc, 
  onSnapshot, query, orderBy, serverTimestamp, writeBatch, where 
} from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";

// For Firebase JS SDK v7.20.0 and later, measurementId is optional
const firebaseConfig = {
  apiKey: "AIzaSyC_5sI9JYaR-bbGWBQFvfl2SX1xe2WRPuE",
  authDomain: "input-nilai-online-c4657.firebaseapp.com",
  projectId: "input-nilai-online-c4657",
  storageBucket: "input-nilai-online-c4657.firebasestorage.app",
  messagingSenderId: "676655325666",
  appId: "1:676655325666:web:0db190cedc613a165199bb",
  measurementId: "G-XYMHEHR27B"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const santriCol = collection(db,'santri');
const mapelCol  = collection(db,'mapel');
const nilaiCol  = collection(db,'nilai');
const guruCol = collection(db, 'guru');
let guruCache = [];

// ====== CONFIGURASI AKSES ======
const PIN_USER  = "1234";  // PIN untuk penginput nilai
const PIN_ADMIN = "555";  // PIN untuk manajemen (Ganti sesuai keinginan)

let userRole = null; // null, 'USER', atau 'ADMIN'
let isAuthorized = false;

function loginAkses() {
  const inputPin = prompt("Masukkan PIN Akses:");
  if (inputPin === PIN_ADMIN) {
    isAuthorized = true;
    userRole = 'ADMIN';
    document.body.classList.remove('role-user'); // Pastikan class user bersih
    activeTab = 'DAFTAR_SANTRI';
    alert("Login berhasil sebagai ADMIN");
  } else if (inputPin === PIN_USER) {
    isAuthorized = true;
    userRole = 'USER';
    document.body.classList.add('role-user'); // TAMBAHKAN INI
    activeTab = 'UH';
    alert("Login berhasil sebagai USER");
  } else {
    alert("PIN Salah!");
    return;
  }
  renderActiveTab();
}

// Pastikan event listener dipasang
document.getElementById('btnLogin').onclick = loginAkses;



// ====== DOM ======
const mainPanel = document.getElementById('mainPanel');
const transactionsPanel = document.getElementById('transactionsPanel');
const transactionsFilter = document.getElementById('transactionsFilter');
const userLabel = document.getElementById('userLabel');
const btnLogin = document.getElementById('btnLogin');
const btnLogout = document.getElementById('btnLogout');

let activeTab = 'UH';
let santriCache = [];
let mapelCache = [];

// ====== HELPERS ======
function escapeHtml(str){ if(!str) return ''; return String(str).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('"','&quot;'); }
function fmtDate(ts){
  try{ if(!ts) return ''; if(ts.toDate) return ts.toDate().toLocaleString(); return String(ts); }catch(e){ return ''; }
}


async function hapusDuplikatSantri(){
  const map = {};
  const batch = writeBatch(db);

  santriCache.forEach(s=>{
    if(!s.nisn) return;
    if(map[s.nisn]){
      batch.delete(doc(db,'santri',s.id));
    } else {
      map[s.nisn] = true;
    }
  });

  await batch.commit();
  alert('Duplikat santri berhasil dibersihkan');
}


// ====== REALTIME SNAPSHOTS ======
onSnapshot(query(santriCol, orderBy('name')), snap=>{
  santriCache = snap.docs.map(d=>({id:d.id, ...d.data()}));

  // ðŸ”¥ RESET filter santri jika sudah kosong
  const santriSelect = document.getElementById('filterSantri');
  if(santriSelect){
    santriSelect.innerHTML = '<option value="">Semua Santri</option>';
  }

  renderActiveTab();
  renderTransactionsWith(window._latestTx || []);
});

onSnapshot(query(mapelCol, orderBy('name')), snap=>{
  mapelCache = snap.docs.map(d=>({id:d.id, ...d.data()}));
  renderActiveTab();
  renderTransactionsWith(window._latestTx || []);
});
onSnapshot(query(nilaiCol, orderBy('createdAt','desc')), snap=>{
  window._latestTx = snap.docs.map(d=>({id:d.id, ...d.data()}));
  
  // HANYA jalankan render transaksi jika yang login adalah ADMIN
  if(userRole === 'ADMIN') {
    renderTransactionsWith(window._latestTx);
  }
  
  if(activeTab === 'REKAP_SISWA' && userRole === 'ADMIN') renderRekapSiswa();
});
onSnapshot(query(guruCol, orderBy('name')), snap => {
  guruCache = snap.docs.map(d => ({ id:d.id, ...d.data() }));

  // hanya render ulang jika tab guru sedang aktif
  if (activeTab === 'DAFTAR_GURU') {
    renderGuruEditor();
  }
});


// ====== TABS ======
document.querySelectorAll('.tab').forEach(t=> t.addEventListener('click', ()=>{
  activeTab = t.dataset.tab;
  renderActiveTab();
}));


function renderFilterUI() {
  const filterArea = document.getElementById('transactionsFilter');
  if (!filterArea) return;

  filterArea.innerHTML = `
    <div style="display:grid; grid-template-columns: 1fr 1fr 1fr; gap:10px; margin-bottom:10px;">
      <input type="text" id="mainSearchSantri" placeholder="Cari Nama Santri..." style="padding:8px; border-radius:8px; border:1px solid #ddd;">
      <select id="mainFilterMapel" style="padding:8px; border-radius:8px; border:1px solid #ddd;">
        <option value="">Semua Mapel</option>
        ${mapelCache.map(m => `<option value="${m.name}">${m.name}</option>`).join('')}
      </select>
      <select id="mainFilterType" style="padding:8px; border-radius:8px; border:1px solid #ddd;">
        <option value="">Semua Tipe</option>
        <option value="UH">UH</option>
        <option value="PTS">PTS</option>
        <option value="PAS_LISAN">PAS Lisan</option>
        <option value="PAS_TULIS">PAS Tulis</option>
        <option value="PAS_PRAKTEK">PAS Praktek</option>
      </select>
    </div>
    <div style="margin-bottom:15px;">
      <button class="btn small ghost" onclick="window.exportToExcel()" style="width:100%; background:#22c55e; color:white; border:none;">
        ðŸ“— DOWNLOAD REKAP EXCEL (.XLSX)
      </button>
    </div>
  `;

  // Langsung pasang event listener setelah innerHTML diisi
  ['mainSearchSantri', 'mainFilterMapel', 'mainFilterType'].forEach(id => {
    const el = document.getElementById(id);
    if(el) {
      el.addEventListener('input', () => {
        currentPage = 1; 
        renderTransactionsWith(window._latestTx || []);
      });
    }
  });
}


// Fungsi ini harus menerima parameter dataList
function renderTransactionsWith(dataList) {
  const panel = document.getElementById('transactionsPanel');
  if (!isAuthorized || userRole !== 'ADMIN' || !panel) {
    if (panel) panel.innerHTML = "";
    return;
  }

  // 1. Ambil Nilai Filter
  const search = document.getElementById('mainSearchSantri')?.value.toLowerCase() || "";
  const fMapel = document.getElementById('mainFilterMapel')?.value || "";
  const fType = document.getElementById('mainFilterType')?.value || "";

  // 2. Logika Filter Data
  const filtered = dataList.filter(d => {
    const matchName = (d.santriName || "").toLowerCase().includes(search);
    const matchMapel = (fMapel === "" || d.mapel === fMapel);
    const matchType = (fType === "" || d.type === fType);
    return matchName && matchMapel && matchType;
  });

  // 3. Logika Paginasi
  const totalPages = Math.ceil(filtered.length / rowsPerPage);
  if (currentPage > totalPages) currentPage = Math.max(1, totalPages);
  
  const start = (currentPage - 1) * rowsPerPage;
  const end = start + rowsPerPage;
  const paginatedData = filtered.slice(start, end);

  // 4. Render HTML
  let html = `
    <div style="margin-bottom:10px; display:flex; justify-content:space-between; align-items:center;">
        <span class="badge">${filtered.length} Total Data</span>
        <button class="btn small delete-all" id="btnHapusSemua">HAPUS SEMUA</button>
    </div>
    <div class="table-responsive">
      <table>
        <thead>
          <tr>
            <th>Santri</th>
            <th>Mapel</th>
            <th>Guru</th>
            <th>Tipe</th>
            <th>Nilai</th>
            <th>Aksi</th>
          </tr>
        </thead>
        <tbody>
          ${paginatedData.map(d => `
            <tr>
              <td data-label="Santri">${escapeHtml(d.santriName)}</td>
              <td data-label="Mapel">${escapeHtml(d.mapel)}</td>
              <td data-label="Guru">${escapeHtml(d.guru || '-')}</td>
              <td data-label="Tipe"><span class="badge badge-${d.type.toLowerCase()}">${d.type}</span></td>
              <td data-label="Nilai"><strong>${d.score}</strong></td>
              <td data-label="Aksi">
                <button class="btn small edit" onclick="window.editSingleNilai('${d.id}', ${d.score})">Edit</button>
                <button class="btn small delete" onclick="window.deleteSingleNilai('${d.id}')">Hapus</button>
              </td>
            </tr>
          `).join('')}
        </tbody>
      </table>
    </div>

    <div style="margin-top:15px; display:flex; justify-content:center; gap:10px; align-items:center;">
      <button class="btn small ghost" ${currentPage === 1 ? 'disabled' : ''} id="prevPage">Prev</button>
      <span style="font-size:13px; font-weight:bold;">Halaman ${currentPage} dari ${totalPages || 1}</span>
      <button class="btn small ghost" ${currentPage >= totalPages ? 'disabled' : ''} id="nextPage">Next</button>
    </div>
  `;
  
  panel.innerHTML = html;

  // 5. Event Listeners
  const btnHapus = document.getElementById('btnHapusSemua');
  if (btnHapus) btnHapus.onclick = hapusSemuaNilai;

  document.getElementById('prevPage').onclick = () => {
    if (currentPage > 1) {
      currentPage--;
      renderTransactionsWith(window._latestTx);
    }
  };

  document.getElementById('nextPage').onclick = () => {
    if (currentPage < totalPages) {
      currentPage++;
      renderTransactionsWith(window._latestTx);
    }
  };
}


function renderActiveTab() {
  const userLabel = document.getElementById('userLabel');
  // Tambahkan baris ini di awal fungsi:
  mainPanel.style.animation = 'none';
  mainPanel.offsetHeight; // Trik "reflow" agar browser sadar animasi di-reset
  mainPanel.style.animation = null;
  const tabsElement = document.querySelectorAll('.tab');
  
  // 1. CEK OTORISASI UMUM
  if (!isAuthorized) {
    userLabel.innerText = "Terkunci";
    mainPanel.innerHTML = `<div style="text-align:center; padding:40px;"><h3>Akses Dibatasi</h3></div>`;
    transactionsPanel.innerHTML = ""; // Kosongkan tabel jika belum login
    transactionsFilter.innerHTML = ""; // Kosongkan filter jika belum login
    return;
  }

  userLabel.innerText = userRole === 'ADMIN' ? "Mode: Admin" : "Mode: Penginput";
  
  // 2. LOGIKA RENDER PANEL UTAMA (Sisi Kiri)
  const adminTabs = ['DAFTAR_SANTRI', 'DAFTAR_MAPEL', 'DAFTAR_GURU', 'REKAP_SISWA'];
  if (userRole === 'USER' && adminTabs.includes(activeTab)) {
    mainPanel.innerHTML = `<div class="card" style="text-align:center; color:red; padding:20px;"><h4>Akses Ditolak!</h4></div>`;
  } else {
    // Jalankan render tab yang dipilih
    if (['UH', 'PTS', 'PAS'].includes(activeTab)) renderInputTab(activeTab);
    else if (activeTab === 'DAFTAR_SANTRI') renderSantriEditor();
    else if (activeTab === 'DAFTAR_MAPEL') renderMapelEditor();
    else if (activeTab === 'DAFTAR_GURU') renderGuruEditor();
    else if (activeTab === 'REKAP_SISWA') renderRekapSiswa();
  }

  // 3. LOGIKA TABEL TRANSAKSI (Sisi Kanan) - INI KUNCINYA
  if (userRole === 'ADMIN') {
    // Tampilkan filter dan tabel hanya untuk ADMIN
    renderFilterUI(); 
    renderTransactionsWith(window._latestTx || []);
  } else {
    // Jika role adalah USER, paksa panel kanan kosong atau beri pesan
    document.getElementById('transactionsFilter').innerHTML = ""; 
    transactionsPanel.innerHTML = `
      <div style="text-align:center; padding:20px; color:#999;">
        <p>Riwayat transaksi hanya dapat dilihat oleh Admin.</p>
        <div style="font-size:40px">ðŸš«</div>
      </div>`;
  }

  tabsElement.forEach(t => t.classList.toggle('active', t.dataset.tab === activeTab));
}


// ====== INPUT TAB ======
function renderInputTab(type){
  const guruOptions = guruCache.length
    ? `<option value="">-- Pilih Guru --</option>` + guruCache.map(g=>`<option value="${escapeHtml(g.name)}">${escapeHtml(g.name)}</option>`).join('')
    : '<option value="">-- kosong --</option>';

  const mapelOptions = mapelCache.length 
    ? `<option value="">-- Pilih Mapel --</option>` + mapelCache.map(m=>`<option value="${escapeHtml(m.name)}">${escapeHtml(m.name)}</option>`).join('') 
    : '<option value="">-- kosong --</option>';

  mainPanel.innerHTML = `
    <h3>Input Nilai â€” ${type}</h3>

    ${type === 'PAS' ? `
      <label>Jenis PAS</label>
      <select id="selectJenisPAS">
        <option value="">-- Pilih Jenis PAS --</option>
        <option value="PAS_LISAN">PAS Lisan</option>
        <option value="PAS_TULIS">PAS Tulis</option>
        <option value="PAS_PRAKTEK">PAS Praktek</option>
      </select>
    ` : ''}

    <label>Pilih Guru Pengampu</label>
    <select id="selectGuru">${guruOptions}</select>

    <label>Pilih Mapel</label>
    <select id="selectMapel">${mapelOptions}</select>

    <div style="margin-top:15px;">
      <label>Cari Nama Santri (Filter Cepat)</label>
      <input type="text" id="quickSearchSantri" placeholder="Ketik nama santri..." 
             style="padding:10px; border-radius:8px; border:1px solid var(--primary); width:100%; margin-bottom:10px;">
    </div>

    <div style="margin-top:10px" class="santri-list" id="santriList">
      ${santriCache.map(s => `
        <div class="santri-row" data-id="${s.id}">
          <div class="santri-name" style="flex:1">${escapeHtml(s.name)}</div>
          <div style="width:100px">
            <input type="number" class="input-score" data-id="${s.id}" placeholder="0-100">
          </div>
        </div>
      `).join('')}
    </div>

    <div style="margin-top:20px; display:flex; gap:10px;">
      <button class="btn" id="btnSimpan" style="flex:1;">SIMPAN NILAI</button>
      <button class="btn ghost" id="btnPreview" style="flex:1;">PREVIEW</button>
    </div>
  `;

  // --- BAGIAN EVENT LISTENER OTOMATISASI MAPEL ---
  const selGuru = document.getElementById('selectGuru');
  const selMapel = document.getElementById('selectMapel');

  selGuru.onchange = (e) => {
    const namaGuruTerpilih = e.target.value;
    // Cari data guru di cache berdasarkan nama
    const dataGuru = guruCache.find(g => g.name === namaGuruTerpilih);

    if (dataGuru && dataGuru.mapel) {
      // Set value selectMapel sesuai mapel yang diampu guru tersebut
      selMapel.value = dataGuru.mapel;
      
      // Opsional: Beri highlight sedikit agar user sadar mapel berubah otomatis
      selMapel.style.backgroundColor = "var(--primary-soft)";
      setTimeout(() => { selMapel.style.backgroundColor = ""; }, 1000);
    } else {
      selMapel.value = "";
    }
  };

  // Event Listeners lainnya
  document.getElementById('btnSimpan').onclick = () => saveScores(type);
  document.getElementById('btnPreview').onclick = () => showInteractivePreview(type);
  
  // Fitur Live Search
  document.getElementById('quickSearchSantri').oninput = (e) => {

    const term = e.target.value.toLowerCase();
    document.querySelectorAll('.santri-row').forEach(row => {
      const name = row.querySelector('.santri-name').innerText.toLowerCase();
      row.style.display = name.includes(term) ? 'flex' : 'none';
    });
  };
// >>> TEMPELKAN KODE VALIDASI REAL-TIME DI SINI <<<
  document.querySelectorAll('.input-score').forEach(input => {
    input.addEventListener('input', (e) => {
      const val = Number(e.target.value);
      if (e.target.value !== "" && (val < 0 || val > 100)) {
        e.target.style.border = "2px solid #ef4444";
        e.target.style.backgroundColor = "#fff1f2";
        e.target.classList.add('error');
      } else {
        e.target.style.border = "";
        e.target.style.backgroundColor = "";
        e.target.classList.remove('error');
      }
    });
  });
} // Akhir dari fungsi renderInputTab


async function saveScores(type) {
  const btnSimpan = document.getElementById('btnSimpan');
  const originalText = btnSimpan.innerHTML;

  const mapel = document.getElementById('selectMapel').value;
  const guru = document.getElementById('selectGuru').value;
  
  // 1. Validasi Input Dasar
  if (!mapel || !guru) return alert('Pilih Mapel dan Guru terlebih dahulu!');

  let finalType = type;
  if (type === 'PAS') {
    const valJenis = document.getElementById('selectJenisPAS').value;
    if (!valJenis) return alert('Pilih Jenis PAS!');
    finalType = valJenis;
  }

  const inputs = document.querySelectorAll('.input-score');
  const batch = writeBatch(db);
  let count = 0;
  let hasError = false; 

  // 2. Proses Validasi Visual & Persiapan Data
  inputs.forEach(input => {
    // Reset status error (hapus border merah jika ada)
    input.classList.remove('error');
    input.style.border = ""; // Reset style manual jika tidak pakai class CSS
    
    const scoreVal = input.value.trim();
    
    if (scoreVal !== "") {
      const scoreNum = Number(scoreVal);

      // Cek apakah angka valid 0-100
      if (isNaN(scoreNum) || scoreNum < 0 || scoreNum > 100) {
        input.classList.add('error'); 
        input.style.border = "2px solid #ef4444"; // Border merah (Danger)
        input.style.backgroundColor = "#fff1f2"; // Background kemerahan
        hasError = true;
      } else {
        const santri = santriCache.find(s => s.id === input.dataset.id);
        const newDocRef = doc(collection(db, 'nilai'));
        batch.set(newDocRef, {
          type: finalType,
          mapel,
          guru,
          santriId: santri.id,
          santriName: santri.name,
          score: scoreNum,
          createdAt: serverTimestamp()
        });
        count++;
      }
    }
  });

  // 3. Batalkan jika ada error visual
  if (hasError) {
    alert("Terdapat nilai tidak valid (harus 0-100). Silakan periksa kolom berwarna merah.");
    return; 
  }

  if (count === 0) {
    return alert("Tidak ada nilai yang diisi.");
  }

  // 4. Proses Simpan ke Firestore
  try {
    // Aktifkan Loading State
    btnSimpan.classList.add('btn-loading');
    btnSimpan.disabled = true;
    btnSimpan.innerHTML = `<span class="spinner"></span> Menyimpan...`;

    await batch.commit();

    alert(`${count} data nilai berhasil disimpan ke database!`);
    
    // Bersihkan semua input setelah berhasil
    inputs.forEach(i => {
      i.value = "";
      i.style.border = "";
      i.style.backgroundColor = "";
    });

  } catch (error) {
    console.error("Error saat menyimpan:", error);
    alert("Gagal menyimpan data. Periksa koneksi internet Anda.");
  } finally {
    // Kembalikan Tombol ke Semula
    btnSimpan.classList.remove('btn-loading');
    btnSimpan.disabled = false;
    btnSimpan.innerHTML = originalText;
  }
}


async function hapusSemuaNilai() {
  if (userRole !== 'ADMIN') {
    alert("Akses Ditolak! Hanya Admin yang dapat menghapus seluruh data transaksi.");
    return;
  }
  const konfirmasi = confirm("PERINGATAN: Anda akan menghapus SELURUH data nilai di database...");
  if (!konfirmasi) return;

  const password = prompt("Masukkan PIN ADMIN untuk konfirmasi penghapusan massal:");
  if (password !== PIN_ADMIN) {
    alert("PIN Salah. Penghapusan dibatalkan.");
    return;
  }

  const batch = writeBatch(db);
  const snap = await getDocs(nilaiCol);
  snap.forEach(d => batch.delete(d.ref));
  await batch.commit();
  alert("Seluruh data nilai telah dibersihkan.");
}

// Fungsi untuk Edit Nilai Tunggal
window.editSingleNilai = async (id, oldScore) => {
  // Proteksi tambahan di sisi kode
  if (userRole !== 'ADMIN') {
    alert("Hanya Admin yang boleh mengedit nilai.");
    return;
  }

  const newScore = prompt(`Ubah nilai santri. (Nilai lama: ${oldScore})`, oldScore);

  // Jika user klik 'Cancel' atau tidak mengisi apapun
  if (newScore === null || newScore.trim() === "") return;

  const scoreNum = Number(newScore);

  // Validasi input angka
  if (isNaN(scoreNum) || scoreNum < 0 || scoreNum > 100) {
    alert("Gagal: Masukkan angka yang valid antara 0 - 100.");
    return;
  }

  try {
    const docRef = doc(db, 'nilai', id);
    await updateDoc(docRef, {
      score: scoreNum,
      updatedAt: serverTimestamp() // Mencatat kapan nilai terakhir diubah
    });
    // Tidak perlu refresh, onSnapshot akan otomatis memperbarui tabel
  } catch (error) {
    console.error("Gagal update:", error);
    alert("Terjadi kesalahan saat menyimpan perubahan.");
  }
};

// Pastikan fungsi hapus tunggal juga tersedia di window agar bisa diklik dari HTML
window.deleteSingleNilai = async (id) => {
  if (userRole !== 'ADMIN') return alert("Hanya Admin yang boleh menghapus.");
  if (!confirm("Apakah Anda yakin ingin menghapus data nilai ini?")) return;
  
  try {
    await deleteDoc(doc(db, 'nilai', id));
  } catch (e) {
    alert("Gagal menghapus data.");
  }
};


window.exportToExcel = () => {
  // 1. Ambil data yang sedang terfilter (dari cache data terakhir)
  const dataToExport = window._latestTx || [];
  
  if (dataToExport.length === 0) {
    alert("Tidak ada data untuk di-export.");
    return;
  }

  // 2. Format data agar rapi di Excel
  const excelData = dataToExport.map((d, index) => ({
    "No": index + 1,
    "Nama Santri": d.santriName,
    "Mata Pelajaran": d.mapel,
    "Guru Pengampu": d.guru || "-",
    "Tipe Nilai": d.type,
    "Skor": d.score,
    "Tanggal Input": d.createdAt ? d.createdAt.toDate().toLocaleString('id-ID') : "-"
  }));

  // 3. Proses konversi menggunakan SheetJS
  const worksheet = XLSX.utils.json_to_sheet(excelData);
  const workbook = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(workbook, worksheet, "Rekap Nilai");

  // 4. Atur lebar kolom otomatis (opsional)
  const wscols = [
    {wch: 5},  // No
    {wch: 25}, // Nama
    {wch: 20}, // Mapel
    {wch: 20}, // Guru
    {wch: 15}, // Tipe
    {wch: 10}, // Skor
    {wch: 20}  // Tanggal
  ];
  worksheet['!cols'] = wscols;

  // 5. Download file
  const fileName = `Rekap_Nilai_${new Date().toISOString().slice(0,10)}.xlsx`;
  XLSX.writeFile(workbook, fileName);
};


function showInteractivePreview(type){
  const inputs = document.querySelectorAll('.input-score');
  const data = Array.from(inputs)
    .map(i => {
      if(i.value.trim() === '') return null;
      const s = santriCache.find(s => s.id === i.dataset.id);
      return { santri: s.name, mapel: document.getElementById('selectMapel').value, type, nilai: i.value };
    })
    .filter(Boolean);

  if(!data.length) return alert('Tidak ada nilai untuk ditampilkan');

  const modal = document.getElementById('previewModal');
  modal.style.display = 'flex';

  modal.innerHTML = `
    <div style="background:#fff;padding:16px;border-radius:12px;max-width:95%;max-height:90%;overflow:auto;position:relative;">
      <button id="closePreview" style="position:absolute;top:8px;right:8px;padding:4px 8px;border:none;background:#f00;color:#fff;border-radius:6px;cursor:pointer;">âœ•</button>
      <h3 style="margin-top:0;margin-bottom:12px;">Preview Nilai Interaktif â€” ${type}</h3>

      <div style="display:flex;flex-wrap:wrap;gap:12px;margin-bottom:12px;align-items:center;">
        <label>Pencarian Santri: <input type="text" id="searchSantri" placeholder="Cari santri..." style="padding:6px;border-radius:6px;border:1px solid #ccc;"></label>

        <label>Filter Mapel:
          <select id="filterMapel" style="padding:6px;border-radius:6px;border:1px solid #ccc;">
            <option value="">Semua Mapel</option>
            ${[...new Set(data.map(d => d.mapel))].map(m=>`<option value="${m}">${m}</option>`).join('')}
          </select>
        </label>

        <label>Filter Tipe:
          <select id="filterType" style="padding:6px;border-radius:6px;border:1px solid #ccc;">
            <option value="">Semua</option>
            <option value="UH">UH</option>
            <option value="PTS">PTS</option>
            <option value="PAS">PAS</option>
          </select>
        </label>

        <button class="btn small" id="btnCopyPreview">Copy ke Clipboard</button>
        <button class="btn small" id="btnExportPreview">Download CSV</button>
      </div>

      <div style="overflow:auto;">
        <table border="1" cellpadding="6" cellspacing="0" style="width:100%;border-collapse:collapse;text-align:left;">
          <thead style="background:#f0f0f0;">
            <tr>
              <th style="padding:8px;">No</th>
              <th style="padding:8px;">Santri</th>
              <th style="padding:8px;">Mapel</th>
              <th style="padding:8px;">Tipe</th>
              <th style="padding:8px;">Nilai</th>
            </tr>
          </thead>
          <tbody id="previewTableBody"></tbody>
        </table>
      </div>
    </div>
  `;

  const tableBody = document.getElementById('previewTableBody');
  const searchInput = document.getElementById('searchSantri');
  const filterMapel = document.getElementById('filterMapel');
  const filterType = document.getElementById('filterType');

  const renderTable = () => {
    const search = searchInput.value.toLowerCase();
    const fMapel = filterMapel.value;
    const fType = filterType.value;

    const filtered = data.filter(d => 
      (!fMapel || d.mapel === fMapel) &&
      (!fType || d.type === fType) &&
      d.santri.toLowerCase().includes(search)
    );

    if(!filtered.length){
      tableBody.innerHTML = `<tr><td colspan="5" style="text-align:center;color:var(--muted)">Tidak ada data sesuai filter</td></tr>`;
      return;
    }

    tableBody.innerHTML = filtered.map((d,i)=>`
      <tr style="border-bottom:1px solid #eee;">
        <td style="padding:6px;">${i+1}</td>
        <td style="padding:6px;">${escapeHtml(d.santri)}</td>
        <td style="padding:6px;">${escapeHtml(d.mapel)}</td>
        <td style="padding:6px;">${escapeHtml(d.type)}</td>
        <td style="padding:6px;">${d.nilai}</td>
      </tr>
    `).join('');
  };

  renderTable();

  // Event filter / search
  searchInput.addEventListener('input', renderTable);
  filterMapel.addEventListener('change', renderTable);
  filterType.addEventListener('change', renderTable);

  // Close modal
  document.getElementById('closePreview').onclick = () => modal.style.display='none';
  modal.onclick = e => { if(e.target === modal) modal.style.display='none'; }

  // Copy ke clipboard
  document.getElementById('btnCopyPreview').onclick = () => {
    const rows = Array.from(tableBody.querySelectorAll('tr'))
      .map(r => Array.from(r.children).map(td => td.innerText).join(','))
      .join('\n');
    navigator.clipboard.writeText(rows).then(()=> alert('Disalin ke clipboard!'));
  };

  // Export CSV
  document.getElementById('btnExportPreview').onclick = () => {
    const rows = Array.from(tableBody.querySelectorAll('tr'))
      .map(r => Array.from(r.children).map(td => `"${td.innerText}"`).join(','));
    const blob = new Blob([['No,Santri,Mapel,Tipe,Nilai'].concat(rows).join('\n')], {type:'text/csv'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = url; a.download = `preview_nilai_interaktif.csv`; a.click();
    URL.revokeObjectURL(url);
  };
}

// ====== DAFTAR SANTRI =====
function renderSantriEditor(){
  mainPanel.innerHTML = `
    <h3>Daftar Santri</h3>
    <hr style="margin:12px 0">

<h4>Tambah Santri Manual</h4>

<div style="display:grid;grid-template-columns:1fr 1fr 1fr auto;gap:8px;align-items:end;margin-bottom:12px">
  <div>
    <label>Nama Santri</label>
    <input type="text" id="newSantriName" placeholder="Nama santri">
  </div>
  <div>
    <label>Kelas</label>
    <input type="text" id="newSantriKelas" placeholder="Kelas">
  </div>
  <div>
    <label>NISN</label>
    <input type="text" id="newSantriNISN" placeholder="NISN">
  </div>
  <div>
    <button class="btn" id="btnAddSantri">Tambah</button>
  </div>
</div>

<hr style="margin:12px 0">

    <input type="file" id="fileSantri" accept=".xlsx,.csv" style="margin-bottom:8px;" />
    <button class="btn small" id="btnImportExcel">Import Excel</button>
    <label>Pilih Sheet</label>
    <select id="sheetSelector" disabled style="margin-bottom:8px;">
    <option value="">-- Pilih Sheet --</option>
    </select>
    <button class="btn small ghost" id="btnDeleteSelected">Hapus Terpilih</button>
    <table id="santriTable"><thead><tr><th><input type="checkbox" id="chkAllSantri"></th><th>Nama</th><th>Kelas</th><th>NISN</th><th>Aksi</th></tr></thead><tbody>${santriCache.map(s=>`<tr data-id="${s.id}"><td><input type="checkbox" class="chkSantri" data-id="${s.id}"></td><td><input class="editableName" value="${escapeHtml(s.name)}"></td><td><input class="editableKelas" value="${escapeHtml(s.kelas||'')}"></td><td><input class="editableNISN" value="${escapeHtml(s.nisn||'')}"></td><td><button class="btn small ghost btnRemoveSantri">Hapus</button></td></tr>`).join('')}</tbody></table>
  `;

let santriWorkbook = null;

document.getElementById('fileSantri').addEventListener('change', async (e)=>{
  const file = e.target.files[0];
  if(!file) return;

  const data = await file.arrayBuffer();
  santriWorkbook = XLSX.read(data);

  const sheetSelector = document.getElementById('sheetSelector');
  sheetSelector.innerHTML = '<option value="">-- Pilih Sheet --</option>';

  santriWorkbook.SheetNames.forEach(name=>{
    sheetSelector.innerHTML += `<option value="${name}">${name}</option>`;
  });

  sheetSelector.disabled = false;
});

  // Import Excel
document.getElementById('btnImportExcel').addEventListener('click', async()=>{
  const fileInput = document.getElementById('fileSantri');
  if(!fileInput.files.length) return alert('Pilih file!');
  
  const file = fileInput.files[0];
  const data = await file.arrayBuffer();
  const workbook = XLSX.read(data);
  const sheetName = document.getElementById('sheetSelector').value;
if(!sheetName) return alert('Pilih sheet terlebih dahulu');

  const worksheet = workbook.Sheets[sheetName];

  const jsonData = XLSX.utils.sheet_to_json(worksheet, {
    header:["name","kelas","nisn"],
    range:1
  });

  if(!jsonData.length) return alert('File kosong!');

  // ðŸ”‘ ambil NISN yang sudah ada
  const existingNISN = santriCache
    .map(s => String(s.nisn || '').trim())
    .filter(n => n);

  const batch = writeBatch(db);
  let added = 0;
  let skipped = 0;

  jsonData.forEach(r=>{
    if(!r.name) return;

    const nisn = String(r.nisn || '').trim();

    // â›” CEK DUPLIKAT
    if(nisn && existingNISN.includes(nisn)){
      skipped++;
      return;
    }

    batch.set(doc(santriCol),{
      name: String(r.name).trim(),
      kelas: r.kelas || '',
      nisn: nisn || '',
      createdAt: serverTimestamp()
    });
    added++;
  });

  if(added === 0){
    alert(`Tidak ada data baru.\nDuplikat dilewati: ${skipped}`);
    return;
  }

  await batch.commit();
  alert(`Import selesai\nDitambahkan: ${added}\nDuplikat dilewati: ${skipped}`);
  fileInput.value = '';
});

  // Hapus massal
  document.getElementById('btnDeleteSelected').addEventListener('click', async()=>{
    const checked = Array.from(document.querySelectorAll('.chkSantri')).filter(c=>c.checked);
    if(!checked.length) return alert('Pilih minimal 1 santri');
    if(!confirm(`Hapus ${checked.length} santri beserta semua nilai?`)) return;
    const batch = writeBatch(db);
    for(const c of checked){
      const id = c.dataset.id;
      batch.delete(doc(santriCol,id));
      const snap = await getDocs(query(nilaiCol,where('santriId','==',id)));
      snap.forEach(d=>batch.delete(d.ref));
    }
    await batch.commit();
    alert(`${checked.length} santri dihapus`);
  });
  document.getElementById('chkAllSantri').addEventListener('change', e=>{ const ch = e.target.checked; document.querySelectorAll('.chkSantri').forEach(c=>c.checked=ch); });
  document.querySelectorAll('.btnRemoveSantri').forEach(btn=>{ btn.addEventListener('click', async e=>{
    const tr = e.target.closest('tr'); const id = tr.dataset.id; if(!confirm('Hapus santri beserta nilai?')) return;
    const batch = writeBatch(db); batch.delete(doc(santriCol,id));
    const snap = await getDocs(query(nilaiCol,where('santriId','==',id))); snap.forEach(d=>batch.delete(d.ref));
    await batch.commit(); alert('Santri dihapus');
  });});
  document.querySelectorAll('.editableName,.editableKelas,.editableNISN').forEach(input=>{ input.addEventListener('change', async e=>{
    const tr = e.target.closest('tr'); const id = tr.dataset.id;
    let field = e.target.classList.contains('editableName')?'name': e.target.classList.contains('editableKelas')?'kelas':'nisn';
    await updateDoc(doc(santriCol,id),{[field]:e.target.value});
  });});

document.getElementById('btnAddSantri').addEventListener('click', async () => {
  const nameInput = document.getElementById('newSantriName');
  const kelasInput = document.getElementById('newSantriKelas');
  const nisnInput = document.getElementById('newSantriNISN');

  const name = nameInput.value.trim();
  const kelas = kelasInput.value.trim();
  const nisn = nisnInput.value.trim();

  if (!name) return alert('Nama santri wajib diisi!');

  // Cek duplikat NISN lokal sebelum simpan
  if (nisn && santriCache.some(s => s.nisn === nisn)) {
    return alert('NISN sudah terdaftar!');
  }

  try {
    await addDoc(santriCol, {
      name: name,
      kelas: kelas,
      nisn: nisn,
      createdAt: serverTimestamp()
    });
    alert('Santri berhasil ditambahkan');
    // Reset input
    nameInput.value = '';
    kelasInput.value = '';
    nisnInput.value = '';
  } catch (e) {
    console.error("Error adding document: ", e);
  }
});

// Lanjutan di dalam fungsi renderSantriEditor
  document.getElementById('btnAddSantri').onclick = async () => {
    const name = document.getElementById('newSantriName').value.trim();
    const kelas = document.getElementById('newSantriKelas').value.trim();
    const nisn = document.getElementById('newSantriNISN').value.trim();
    if (!name) return alert("Nama harus diisi");
    
    await addDoc(santriCol, { name, kelas, nisn, createdAt: serverTimestamp() });
    alert("Santri berhasil ditambahkan!");
  };

  document.getElementById('btnDeleteSelected').onclick = async () => {
    const checked = document.querySelectorAll('.chkSantri:checked');
    if (!checked.length || !confirm(`Hapus ${checked.length} santri terpilih?`)) return;

    const batch = writeBatch(db);
    checked.forEach(cb => batch.delete(doc(db, 'santri', cb.dataset.id)));
    await batch.commit();
    alert("Data berhasil dihapus.");
  };

  // Event untuk Update Otomatis saat input diedit (Debounce dianjurkan untuk produksi)
  document.querySelectorAll('.editableName').forEach(input => {
    input.onchange = async (e) => {
      const id = e.target.closest('tr').dataset.id;
      await updateDoc(doc(db, 'santri', id), { name: e.target.value });
    };
  });
}

// Listener untuk Update Nama/Kelas/NISN secara Realtime
document.querySelectorAll('#santriTable input').forEach(input => {
  input.addEventListener('change', async (e) => {
    const id = e.target.closest('tr').dataset.id;
    const field = e.target.className === 'editableName' ? 'name' : 
                  e.target.className === 'editableKelas' ? 'kelas' : 'nisn';
    const value = e.target.value;

    try {
      await updateDoc(doc(db, 'santri', id), { [field]: value });
      console.log("Data diperbarui");
    } catch (err) {
      alert("Gagal memperbarui: " + err.message);
    }
  });
});


async function previewExcelFile(){
  const fileInput = document.getElementById('excelInput');
  if(!fileInput.files.length) return alert('Pilih file Excel terlebih dahulu');
  const file = fileInput.files[0];
  const reader = new FileReader();
  reader.onload = function(e){
    const data = new Uint8Array(e.target.result);
    const workbook = XLSX.read(data, { type: 'array' });
    const sheetName = workbook.SheetNames[0];
    const worksheet = workbook.Sheets[sheetName];
    const jsonData = XLSX.utils.sheet_to_json(worksheet);
    if(!jsonData.length) return alert('File kosong atau tidak cocok');
    // Show preview in modal
    const modal = document.getElementById('previewModal');
    modal.style.display = 'flex';
    modal.innerHTML = `<div style="background:#fff;padding:16px;border-radius:12px;max-width:95%;max-height:90%;overflow:auto;position:relative;"><button id="closePreview" style="position:absolute;top:8px;right:8px;padding:4px 8px;border:none;background:#f00;color:#fff;border-radius:6px;cursor:pointer;">âœ•</button><h3 style="margin-top:0">Preview Data Excel (${jsonData.length} baris)</h3><div style="overflow:auto;"><table style="width:100%;border-collapse:collapse"><thead><tr>${Object.keys(jsonData[0]).map(h=>`<th style="padding:8px;border:1px solid #eee">${escapeHtml(h)}</th>`).join('')}</tr></thead><tbody>${jsonData.map(r=>`<tr>${Object.values(r).map(v=>`<td style="padding:6px;border:1px solid #eee">${escapeHtml(String(v||''))}</td>`).join('')}</tr>`).join('')}</tbody></table></div></div>`;
    document.getElementById('closePreview').onclick = ()=> modal.style.display='none';
    modal.onclick = e => { if(e.target === modal) modal.style.display='none'; }
  };
  reader.readAsArrayBuffer(file);
}


async function importSantriExcel(){
  const fileInput = document.getElementById('excelInput');
  if(!fileInput.files.length) return alert('Pilih file Excel terlebih dahulu');
  const file = fileInput.files[0];
  const reader = new FileReader();

  reader.onload = async function(e){
    const data = new Uint8Array(e.target.result);
    const workbook = XLSX.read(data, { type: 'array' });
    const sheetName = workbook.SheetNames[0];
    const worksheet = workbook.Sheets[sheetName];
    const jsonData = XLSX.utils.sheet_to_json(worksheet);

    if(!jsonData.length) return alert('File kosong atau format tidak sesuai');

    // expected headers: Nama, Kelas, Alamat, NISN (case-insensitive)
    // normalize keys
    const normalized = jsonData.map(row=>{
      const out = {};
      Object.keys(row).forEach(k=>{
        const key = k.toString().trim().toLowerCase();
        if(key==='nama' || key==='name') out.name = row[k];
        else if(key==='kelas') out.kelas = row[k];
        else if(key==='alamat') out.alamat = row[k];
        else if(key==='nisn') out.nisn = row[k];
      });
      return out;
    }).filter(r=>r.name && String(r.name).trim());

    if(!normalized.length) return alert('Tidak menemukan kolom Nama (header "Nama")');

    // Check duplicates by NISN in santriCache
    const batch = writeBatch(db);
    let added = 0;
    let skipped = 0;

    normalized.forEach(r=>{
      const nisn = r.nisn ? String(r.nisn).trim() : '';
      const exists = nisn && santriCache.some(s => s.nisn && String(s.nisn).trim() === nisn);
      if(exists){ skipped++; return; }
      const ref = doc(collection(db,'santri'));
      batch.set(ref, { name: String(r.name).trim(), kelas: r.kelas || '', alamat: r.alamat || '', nisn: nisn || '', createdAt: serverTimestamp() });
      added++;
    });

    if(added===0){ alert(`Tidak ada data baru yang ditambahkan. Dilewati: ${skipped} duplikat (berdasarkan NISN).`); return; }

    try{
      await batch.commit();
      alert(`Import selesai. Ditambahkan: ${added}. Dilewati karena duplikat NISN: ${skipped}.`);
      fileInput.value = '';
      renderSantriEditor();
    }catch(err){ console.error(err); alert('Gagal mengimport: '+err.message); }
  };

  reader.readAsArrayBuffer(file);
}

function renderMapelEditor(){
  mainPanel.innerHTML = `
    <h3>DAFTAR MAPEL</h3>

    <input type="file" id="fileMapel" accept=".xlsx,.csv" style="margin-bottom:8px;" />
    <button class="btn small" id="btnImportMapel">Import Excel</button>

    <label>Pilih Sheet</label>
    <select id="sheetSelectorMapel" disabled style="margin-bottom:8px;">
      <option value="">-- Pilih Sheet --</option>
    </select>

    <hr style="margin:12px 0">

    <label>Tambah Mapel Manual</label>
    <div class="list-editor">
      <input type="text" id="newMapelName" placeholder="Nama mapel...">
      <button class="btn" id="btnAddMapel">Tambah</button>
    </div>

<div style="margin-top:12px;max-height:420px;overflow:auto">
  <button class="btn small ghost" id="btnDeleteSelectedMapel">Hapus Terpilih</button>

  <table style="width:100%;margin-top:8px">
    <thead>
      <tr>
        <th><input type="checkbox" id="chkAllMapel"></th>
        <th>Nama Mapel</th>
        <th style="width:120px">Aksi</th>
      </tr>
    </thead>
    <tbody id="mapelTableBody">
      ${mapelCache.map(m=>`
        <tr data-id="${m.id}">
          <td>
            <input type="checkbox" class="chkMapel" data-id="${m.id}" data-name="${escapeHtml(m.name)}">
          </td>
          <td>
            <input class="editableMapel" data-id="${m.id}" value="${escapeHtml(m.name)}">
          </td>
          <td>
            <button class="btn small ghost btnRemoveMapel" data-id="${m.id}">Hapus</button>
          </td>
        </tr>
      `).join('')}
    </tbody>
  </table>
</div>

  `;

document.getElementById('chkAllMapel').addEventListener('change', e=>{
  const checked = e.target.checked;
  document.querySelectorAll('.chkMapel').forEach(c=> c.checked = checked);
});

document.getElementById('btnDeleteSelectedMapel').addEventListener('click', async ()=>{
  const checked = Array.from(document.querySelectorAll('.chkMapel')).filter(c=>c.checked);
  if(!checked.length) return alert('Pilih minimal 1 mapel');

  const mapelNames = checked.map(c => c.dataset.name);

  if(!confirm(`Hapus ${checked.length} mapel beserta SEMUA nilai terkait?`)) return;

  const batch = writeBatch(db);

  for(const c of checked){
    const id = c.dataset.id;
    const name = c.dataset.name;

    // hapus mapel
    batch.delete(doc(mapelCol, id));

    // hapus semua nilai yg pakai mapel tsb
    const snap = await getDocs(query(nilaiCol, where('mapel','==', name)));
    snap.forEach(d => batch.delete(d.ref));
  }

  await batch.commit();
  alert(`${checked.length} mapel berhasil dihapus`);
});


let mapelWorkbook = null;

document.getElementById('fileMapel').addEventListener('change', async (e)=>{
  const file = e.target.files[0];
  if(!file) return;

  const data = await file.arrayBuffer();
  mapelWorkbook = XLSX.read(data);

  const selector = document.getElementById('sheetSelectorMapel');
  selector.innerHTML = '<option value="">-- Pilih Sheet --</option>';

  mapelWorkbook.SheetNames.forEach(name=>{
    selector.innerHTML += `<option value="${name}">${name}</option>`;
  });

  selector.disabled = false;
});

document.getElementById('btnImportMapel').addEventListener('click', async ()=>{
  if(!mapelWorkbook) return alert('Pilih file Excel terlebih dahulu');

  const sheetName = document.getElementById('sheetSelectorMapel').value;
  if(!sheetName) return alert('Pilih sheet terlebih dahulu');

  const worksheet = mapelWorkbook.Sheets[sheetName];

  const jsonData = XLSX.utils.sheet_to_json(worksheet, {
    header: ["name"],
    range: 1
  });

  if(!jsonData.length) return alert('Sheet kosong');

  // Ambil mapel yang sudah ada
  const existingMapel = mapelCache.map(m => m.name.toLowerCase().trim());

  const batch = writeBatch(db);
  let added = 0;
  let skipped = 0;

  jsonData.forEach(r=>{
    if(!r.name) return;

    const name = String(r.name).trim();
    if(existingMapel.includes(name.toLowerCase())){
      skipped++;
      return;
    }

    batch.set(doc(mapelCol), {
      name,
      createdAt: serverTimestamp()
    });
    added++;
  });

  if(added === 0){
    alert(`Tidak ada mapel baru.\nDuplikat dilewati: ${skipped}`);
    return;
  }

  await batch.commit();
  alert(`Import selesai\nDitambahkan: ${added}\nDuplikat dilewati: ${skipped}`);

  document.getElementById('fileMapel').value = '';
});


  document.getElementById('btnAddMapel').addEventListener('click', async ()=>{ const v = document.getElementById('newMapelName').value.trim(); if(!v) return alert('Isi nama mapel terlebih dahulu'); await addDoc(collection(db,'mapel'), { name: v }); document.getElementById('newMapelName').value = ''; });
  document.querySelectorAll('.btnRemoveMapel').forEach(b=>b.addEventListener('click', async (e)=>{ const id = e.currentTarget.dataset.id; if(!confirm('Hapus mapel ini?')) return; await deleteDoc(doc(db,'mapel',id)); }));
  document.querySelectorAll('.editableMapel').forEach(input=>input.addEventListener('change', async e=>{ const id = e.target.dataset.id; const val = e.target.value.trim(); if(!val) return alert('Tidak boleh kosong'); await updateDoc(doc(db,'mapel',id),{ name: val }); }));
}

// ====== REKAP SISWA ======
function avg(arr){
  if(!arr || !arr.length) return 0;
  return arr.reduce((a,b)=>a+b,0) / arr.length;
}

function renderRekapSiswa(page = 1) {

  // ======================================
  // DROPDOWN ROWS PER PAGE (dengan cache)
  // ======================================
  let rowsPerPage = parseInt(localStorage.getItem("rekap_rows_per_page") || "10");
  if (![10, 20, 50, 100].includes(rowsPerPage)) rowsPerPage = 10;

  let weightUH = parseFloat(document.getElementById('weightUH')?.value) || 0.3;
  let weightPTS = parseFloat(document.getElementById('weightPTS')?.value) || 0.3;
  let weightPAS = parseFloat(document.getElementById('weightPAS')?.value) || 0.4;

  const selectMapel = document.getElementById('rekapFilterMapel');
  const fMapelArr = selectMapel ? Array.from(selectMapel.selectedOptions).map(o => o.value) : [];

  const grouped = {};
  (window._latestTx || []).forEach(t => {
    if(!grouped[t.santriName]) grouped[t.santriName] = [];
    grouped[t.santriName].push(t);
  });

  const mapelOptions = mapelCache
    .map(m => `<option value="${m.name}" ${fMapelArr.includes(m.name) ? 'selected' : ''}>${m.name}</option>`)
    .join('');

  function formatScore(num){
    if(num === '' || num == null || isNaN(num)) return '';
    return Number(num.toFixed(2)).toString().replace('.', ',');
  }

  // ======================================
  // SUSUN DATA TABEL
  // ======================================
  let tableData = [];

  Object.keys(grouped).forEach(s => {
    const mapels = [...new Set(grouped[s].map(t => t.mapel))];
    mapels.forEach(mapelName => {
      if(fMapelArr.length && !fMapelArr.includes(mapelName)) return;

      const arr = grouped[s].filter(t => t.mapel === mapelName);
const uhArr = arr.filter(t => t.type === 'UH').map(t => t.score);
const ptsArr = arr.filter(t => t.type === 'PTS').map(t => t.score);

// PAS TANPA BOBOT (rata-rata murni)
const pasLisanArr   = arr.filter(t => t.type === 'PAS_LISAN').map(t => t.score);
const pasTulisArr   = arr.filter(t => t.type === 'PAS_TULIS').map(t => t.score);
const pasPraktekArr = arr.filter(t => t.type === 'PAS_PRAKTEK').map(t => t.score);

// Rata-rata UH & PTS
const uh  = uhArr.length ? formatScore(avg(uhArr)) : '';
const pts = ptsArr.length ? formatScore(avg(ptsArr)) : '';

// Rata-rata masing-masing PAS (tanpa bobot)
const pasLisanAvg   = pasLisanArr.length   ? avg(pasLisanArr)   : '';
const pasTulisAvg   = pasTulisArr.length   ? avg(pasTulisArr)   : '';
const pasPraktekAvg = pasPraktekArr.length ? avg(pasPraktekArr) : '';

// PAS Akhir = gabungan semua PAS (TANPA BOBOT)
const pasGabungan = [
  ...pasLisanArr,
  ...pasTulisArr,
  ...pasPraktekArr
];

const pasAkhir = pasGabungan.length ? avg(pasGabungan) : 0;

// Nilai Akhir (NA) â€” tetap pakai bobot
const na = formatScore(
  avg(uhArr)  * weightUH +
  avg(ptsArr) * weightPTS +
  pasAkhir    * weightPAS
);

// Masukkan ke tabel
tableData.push({
  santri: s,
  mapel: mapelName,
  uh,
  pts,
  pasLisan: pasLisanAvg !== '' ? formatScore(pasLisanAvg) : '',
  pasTulis: pasTulisAvg !== '' ? formatScore(pasTulisAvg) : '',
  pasPraktek: pasPraktekAvg !== '' ? formatScore(pasPraktekAvg) : '',
  na
});


    });
  });

  // ======================================
  // PAGINASI
  // ======================================
  const totalRows = tableData.length;
  const totalPages = Math.max(1, Math.ceil(totalRows / rowsPerPage));

  if (page < 1) page = 1;
  if (page > totalPages) page = totalPages;

  const start = (page - 1) * rowsPerPage;
  const paginatedRows = tableData.slice(start, start + rowsPerPage);

  // ======================================
  // BANGUN HTML
  // ======================================
  let html = `
    <h3>REKAP PER SISWA</h3>

    <div class="weight-container">
      <div class="weight-item">
        <label><input type="checkbox" id="chkSelectAllMapel"> Pilih Semua Mapel</label><br>
        <label>Filter Mapel:</label>
        <select id="rekapFilterMapel" multiple size="5">${mapelOptions}</select>
      </div>

      <div class="weight-item">
        <label>Bobot UH:</label>
        <input type="number" id="weightUH" value="${weightUH}" step="0.05" min="0" max="1">
      </div>
      <div class="weight-item">
        <label>Bobot PTS:</label>
        <input type="number" id="weightPTS" value="${weightPTS}" step="0.05" min="0" max="1">
      </div>

<div class="weight-item">
  <label>Bobot PAS (Total):</label>
  <input type="number" id="weightPAS" value="0.4" step="0.05" min="0" max="1">
</div>

      <button class="btn small" id="btnUpdateNA">Update NA</button>
      <div id="weightError" style="color:red;font-size:13px;margin-top:4px;"></div>

      <button class="btn small" id="btnExportCSV" style="margin-left:12px;">Export CSV</button>
    </div>

    <!-- DROPDOWN ROWS PER PAGE -->
    <div style="margin-top:10px;">
      <label>Tampilkan:</label>
      <select id="rowsPerPageSelect" style="padding:4px 6px;">
        <option value="10" ${rowsPerPage===10?'selected':''}>10 baris</option>
        <option value="20" ${rowsPerPage===20?'selected':''}>20 baris</option>
        <option value="50" ${rowsPerPage===50?'selected':''}>50 baris</option>
        <option value="100" ${rowsPerPage===100?'selected':''}>100 baris</option>
      </select>
    </div>

    <div id="rekapTableWrapper" style="margin-top:12px; overflow:auto;">
      <table id="rekapTable">
        <thead>
          <tr>
             <th>Santri</th>
             <th>Mapel</th>
             <th>UH</th>
             <th>PTS</th>
             <th>PAS Lisan</th>
             <th>PAS Tulis</th>
             <th>PAS Praktek</th>
             <th>NA</th>
          </tr>
        </thead>

        <tbody>
  `;

paginatedRows.forEach(r => {
  html += `
    <tr>
      <td data-label="Santri">${escapeHtml(r.santri)}</td>
      <td data-label="Mapel">${escapeHtml(r.mapel)}</td>
      <td data-label="UH">${r.uh}</td>
      <td data-label="PTS">${r.pts}</td>
      <td data-label="PAS Lisan">${r.pasLisan}</td>
      <td data-label="PAS Tulis">${r.pasTulis}</td>
      <td data-label="PAS Praktek">${r.pasPraktek}</td>
      <td data-label="NA" class="na-cell">${r.na}</td>
    </tr>
  `;
});


  html += `
        </tbody>
      </table>
    </div>

    <div style="margin-top:10px; display:flex; gap:10px; align-items:center;">
      <button class="btn small" id="pgPrev" ${page<=1?'disabled':''}>Prev</button>
      <span>Halaman ${page} dari ${totalPages}</span>
      <button class="btn small" id="pgNext" ${page>=totalPages?'disabled':''}>Next</button>
    </div>
  `;

  mainPanel.innerHTML = html;

  // ======================================
  // EVENT: DROPDOWN ROWS PER PAGE
  // ======================================
  document.getElementById("rowsPerPageSelect").onchange = e => {
    const val = parseInt(e.target.value);
    localStorage.setItem("rekap_rows_per_page", val);
    renderRekapSiswa(1); // reset ke halaman 1
  };

  // ======================================
  // EVENT PAGINASI
  // ======================================
  document.getElementById("pgPrev").onclick = () => renderRekapSiswa(page - 1);
  document.getElementById("pgNext").onclick = () => renderRekapSiswa(page + 1);

  // ======================================
  // EVENT CEK BOBOT
  // ======================================
  const btnUpdate = document.getElementById('btnUpdateNA');
  const errorDiv = document.getElementById('weightError');
  const inputs = [
    document.getElementById('weightUH'),
    document.getElementById('weightPTS'),
    document.getElementById('weightPAS')
  ];

  function checkTotalWeight() {
    const total = inputs.reduce((sum, el) => sum + parseFloat(el.value || 0), 0);
    if(total !== 1){
      errorDiv.innerText = `Total bobot UH + PTS + PAS harus 1. Saat ini: ${total}`;
      btnUpdate.disabled = true;
    } else {
      errorDiv.innerText = '';
      btnUpdate.disabled = false;
    }
  }

  inputs.forEach(i => i.addEventListener('input', checkTotalWeight));
  checkTotalWeight();

  // ======================================
  // MULTI SELECT MAPEL
  // ======================================
  const chkAll = document.getElementById('chkSelectAllMapel');
  const selMapel = document.getElementById('rekapFilterMapel');

  chkAll.checked = selMapel && Array.from(selMapel.options).every(o => o.selected);

  chkAll.addEventListener('change', e => {
    const check = e.target.checked;
    Array.from(selMapel.options).forEach(o => o.selected = check);
    renderRekapSiswa(1);
  });

  selMapel.addEventListener('change', () => {
    chkAll.checked = Array.from(selMapel.options).every(o => o.selected);
    renderRekapSiswa(1);
  });

  btnUpdate.addEventListener('click', () => renderRekapSiswa(1));

  // ======================================
  // EXPORT CSV
  // ======================================
  document.getElementById("btnExportCSV").onclick = () => {
    const rows = tableData; // ekspor semua data, bukan hanya halaman
    let csv = [];

    csv.push(`"Santri","Mapel","UH","PTS","PAS Lisan","PAS Tulis","PAS Praktek","NA"`);

    rows.forEach(r => {
csv.push([
  r.santri,
  r.mapel,
  r.uh,
  r.pts,
  r.pasLisan,
  r.pasTulis,
  r.pasPraktek,
  r.na
].map(v => `"${v ?? ''}"`).join(','));

    });

    const blob = new Blob([csv.join("\n")], { type: "text/csv" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");

    a.href = url;
    a.download = `rekap_siswa.csv`;
    a.click();
    URL.revokeObjectURL(url);
  };
}



// ====== TRANSAKSI PANEL DENGAN FILTER (DIPADUKAN DENGAN PAGINASI) ======
transactionsFilter.innerHTML = `
<div style="display:flex;gap:8px;margin-bottom:8px;align-items:center;flex-wrap:wrap">
  <label style="margin-bottom:0">Tipe</label>
  <select id="filterType">
    <option value="">Semua</option>
    <option value="UH">UH</option>
    <option value="PTS">PTS</option>
    <option value="PAS_LISAN">PAS Lisan</option>
    <option value="PAS_TULIS">PAS Tulis</option>
    <option value="PAS_PRAKTEK">PAS Praktek</option>
  </select>

  <label style="margin-bottom:0">Mapel</label>
  <select id="filterMapel"><option value="">Semua Mapel</option></select>

  <label style="margin-bottom:0">Santri</label>
  <select id="filterSantri"><option value="">Semua Santri</option></select>

  <button class="btn small" id="btnExport">Export CSV</button>
</div>
`;

// Tambah dropdown rows per page
const rowsPerPageBox = document.createElement("div");
rowsPerPageBox.style = "margin: 10px 0;";
rowsPerPageBox.innerHTML = `
  <label>Rows per page:
    <select id="rowsPerPage">
      <option value="10">10</option>
      <option value="25">25</option>
      <option value="50">50</option>
    </select>
  </label>
`;
transactionsFilter.appendChild(rowsPerPageBox);

// ==============PAGINATION STATE=========

let pageSize = 10;

// Utility: change page (delta = +1 or -1)
function changePage(delta){
  currentPage = Math.max(1, currentPage + delta);
  renderTransactionsWith(window._latestTx || []);
}

// Edit & Delete helper functions (dipanggil dari tombol)
window.editTransaksi = async function(id){
  const d = (window._latestTx || []).find(t => t.id === id);
  if(!d) return alert('Data tidak ditemukan');
  const val = prompt(`Edit nilai ${d.santriName} (${d.type} - ${d.mapel}):`, d.score);
  if(val === null) return;
  const n = Number(val);
  if(isNaN(n)) return alert('Input salah');
  try{
    await updateDoc(doc(db,'nilai',id), { score: n, updatedAt: serverTimestamp() });
    alert('Nilai diperbarui');
  }catch(e){ console.error(e); alert('Gagal update'); }
};

window.deleteTransaksi = async function(id){
  if(!confirm('Hapus transaksi ini?')) return;
  try{
    await deleteDoc(doc(db,'nilai',id));
  }catch(err){ console.error(err); alert('Gagal menghapus'); }
};


function labelType(type){
  if(type === 'PAS_LISAN') return 'PAS Lisan';
  if(type === 'PAS_TULIS') return 'PAS Tulis';
  if(type === 'PAS_PRAKTEK') return 'PAS Praktek';
  return type;
}


// Variabel Global untuk Pagination
function renderFilterBar() {
  const filterContainer = document.getElementById('transactionsFilter');
  if (!filterContainer) return;

  filterContainer.innerHTML = `
    <div style="display:flex; gap:8px; margin-bottom:12px; flex-wrap:wrap;">
      <input type="text" id="filterSearch" placeholder="Cari Nama Santri..." 
        style="padding:8px; border-radius:8px; border:1px solid #ccc; flex:1;">
      
      <select id="filterType" style="padding:8px; border-radius:8px; border:1px solid #ccc;">
        <option value="">Semua Tipe</option>
        <option value="UH">UH</option>
        <option value="PTS">PTS</option>
        <option value="PAS_LISAN">PAS Lisan</option>
        <option value="PAS_TULIS">PAS Tulis</option>
        <option value="PAS_PRAKTEK">PAS Praktek</option>
      </select>

      <button class="btn small delete-all" id="btnHapusSemua">Hapus Semua Data</button>
    </div>
  `;

  // Tambahkan event listener untuk pencarian otomatis
  document.getElementById('filterSearch').addEventListener('input', () => {
    renderTransactionsWith(window._latestTx || []);
  });

  document.getElementById('filterType').addEventListener('change', () => {
    renderTransactionsWith(window._latestTx || []);
  });

  // Logika Hapus Semua (Hanya Admin)
  document.getElementById('btnHapusSemua').onclick = async () => {
    if (confirm('PERINGATAN: Hapus SEMUA data nilai secara permanen?')) {
      const batch = writeBatch(db);
      const snap = await getDocs(nilaiCol);
      snap.forEach(d => batch.delete(d.ref));
      await batch.commit();
      alert('Semua data berhasil dihapus.');
    }
  };
}


// ====== DAFTAR GURU =====
function renderGuruEditor() {
  // Ambil opsi mapel dari cache untuk dropdown guru
  const mapelOptions = mapelCache.length 
    ? mapelCache.map(m => `<option value="${escapeHtml(m.name)}">${escapeHtml(m.name)}</option>`).join('')
    : '<option value="">-- Isi Daftar Mapel Terlebih Dahulu --</option>';

  mainPanel.innerHTML = `
    <h3>MANAJEMEN DAFTAR GURU</h3>

    <div style="background: #f1f5f9; padding: 15px; border-radius: 12px; margin-bottom: 20px; border: 1px dashed #cbd5e1;">
      <label style="font-weight:bold; color:var(--primary-dark);">Import Guru (Excel)</label>
      <input type="file" id="fileGuru" accept=".xlsx,.csv" style="display:block; margin: 10px 0;" />
      <div style="display:flex; gap:8px;">
        <button class="btn small" id="btnImportGuru">1. Baca File</button>
        <select id="sheetSelectorGuru" disabled style="flex:1;">
          <option value="">2. Pilih Sheet</option>
        </select>
      </div>
      <p style="font-size:11px; color:var(--muted); margin-top:8px;">Format Kolom: <b>Nama, NIP, Mapel</b></p>
    </div>

    <div class="card" style="padding:15px; border:1px solid #e2e8f0; margin-bottom:20px;">
      <label style="font-weight:bold;">Tambah Guru Secara Manual</label>
      <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-top:8px;">
        <input type="text" id="guruName" placeholder="Nama Lengkap" style="width:100%" />
        <input type="text" id="guruNip" placeholder="NIP/NIY (Opsional)" style="width:100%" />
      </div>
      <select id="guruMapel" style="width:100%; margin:10px 0;">
        <option value="">-- Pilih Mapel Pengampu --</option>
        ${mapelOptions}
      </select>
      <button class="btn" id="btnAddGuru" style="width:100%">Tambah Guru</button>
    </div>

    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
      <button class="btn small delete-all" id="btnDeleteSelectedGuru">Hapus Terpilih</button>
      <span class="badge">${guruCache.length} Guru Terdaftar</span>
    </div>

    <div class="table-responsive">
      <table style="width:100%; background:#fff;">
        <thead>
          <tr>
            <th width="40"><input type="checkbox" id="checkAllGuru"></th>
            <th>Nama Guru</th>
            <th>NIP</th>
            <th>Mapel diampu</th>
            <th width="80">Aksi</th>
          </tr>
        </thead>
        <tbody id="guruTableBody">
          ${guruCache.map(g => `
            <tr>
              <td><input type="checkbox" class="checkGuru" data-id="${g.id}"></td>
              <td><b>${escapeHtml(g.name)}</b></td>
              <td>${escapeHtml(g.nip || '-')}</td>
              <td><span class="badge" style="background:var(--primary-soft); color:var(--primary-dark);">${escapeHtml(g.mapel || '-')}</span></td>
              <td>
                <button class="btn small delete" onclick="window.deleteGuru('${g.id}')">Hapus</button>
              </td>
            </tr>
          `).join('')}
        </tbody>
      </table>
    </div>
  `;

  // --- LOGIKA EVENT LISTENERS ---

  // 1. Tambah Guru Manual
  document.getElementById('btnAddGuru').onclick = async () => {
    const btn = document.getElementById('btnAddGuru');
    const name = document.getElementById('guruName').value.trim();
    const nip = document.getElementById('guruNip').value.trim();
    const mapel = document.getElementById('guruMapel').value;

    if (!name || !mapel) return alert("Nama dan Mapel wajib diisi!");

    btn.disabled = true;
    btn.innerHTML = "Menyimpan...";

    try {
      await addDoc(guruCol, {
        name,
        nip,
        mapel,
        createdAt: serverTimestamp()
      });
      // Reset Form
      document.getElementById('guruName').value = "";
      document.getElementById('guruNip').value = "";
      document.getElementById('guruMapel').value = "";
      alert("Guru berhasil ditambahkan!");
    } catch (e) {
      alert("Gagal menambah data.");
    } finally {
      btn.disabled = false;
      btn.innerHTML = "Tambah Guru";
    }
  };

  // 2. Logika Import Excel
  let workbookGuru;
  document.getElementById('btnImportGuru').onclick = () => {
    const fileInput = document.getElementById('fileGuru');
    if (!fileInput.files[0]) return alert("Pilih file Excel dulu!");

    const reader = new FileReader();
    reader.onload = (e) => {
      const data = new Uint8Array(e.target.result);
      workbookGuru = XLSX.read(data, { type: 'array' });
      const selector = document.getElementById('sheetSelectorGuru');
      
      selector.innerHTML = '<option value="">-- Pilih Sheet --</option>' + 
        workbookGuru.SheetNames.map(s => `<option value="${s}">${s}</option>`).join('');
      selector.disabled = false;
      alert("File terbaca. Silakan pilih sheet untuk eksekusi import.");
    };
    reader.readAsArrayBuffer(fileInput.files[0]);
  };

  // 3. Eksekusi Import dari Sheet
  document.getElementById('sheetSelectorGuru').onchange = async (e) => {
    const sheetName = e.target.value;
    if (!sheetName) return;

    if (!confirm(`Import data dari sheet "${sheetName}"?`)) return;

    const worksheet = workbookGuru.Sheets[sheetName];
    const jsonData = XLSX.utils.sheet_to_json(worksheet);
    const batch = writeBatch(db);

    jsonData.forEach(row => {
      const newRef = doc(guruCol);
      batch.set(newRef, {
        name: row.Nama || row.nama || '',
        nip: String(row.NIP || row.nip || ''),
        mapel: row.Mapel || row.mapel || '',
        createdAt: serverTimestamp()
      });
    });

    try {
      await batch.commit();
      alert(`Berhasil mengimpor ${jsonData.length} data guru.`);
      document.getElementById('fileGuru').value = "";
      e.target.disabled = true;
    } catch (err) {
      alert("Terjadi kesalahan saat batch import.");
    }
  };

  // 4. Fitur Checkbox Select All
  document.getElementById('checkAllGuru').onclick = (e) => {
    document.querySelectorAll('.checkGuru').forEach(cb => cb.checked = e.target.checked);
  };

  // 5. Hapus Massal Guru
  document.getElementById('btnDeleteSelectedGuru').onclick = async () => {
    const selected = document.querySelectorAll('.checkGuru:checked');
    if (selected.length === 0) return alert("Pilih guru yang ingin dihapus.");

    if (confirm(`Hapus ${selected.length} guru terpilih secara permanen?`)) {
      const batch = writeBatch(db);
      selected.forEach(cb => {
        batch.delete(doc(db, 'guru', cb.dataset.id));
      });
      await batch.commit();
      alert("Data terpilih berhasil dihapus.");
    }
  };
}

// Ekspos fungsi delete tunggal ke scope window
window.deleteGuru = async (id) => {
  if (confirm("Hapus data guru ini secara permanen?")) {
    try {
      await deleteDoc(doc(db, 'guru', id));
    } catch (e) {
      alert("Gagal menghapus data.");
    }
  }
};


// ====== AUTH SISTEM PIN (VERSI PERBAIKAN) ======
function checkPin() {
    const userPin = prompt("Masukkan PIN Akses:");
    
    if (userPin === PIN_ADMIN) {
        isAuthorized = true;
        userRole = 'ADMIN';
        activeTab = 'DAFTAR_SANTRI'; // Admin langsung ke menu manajemen
        alert("Login berhasil sebagai ADMIN");
    } else if (userPin === PIN_USER) {
        isAuthorized = true;
        userRole = 'USER';
        activeTab = 'UH'; // User biasa langsung ke menu input
        alert("Login berhasil sebagai PENGINPUT");
    } else {
        alert("PIN Salah!");
        return; // Keluar jika salah
    }
    
    // Update tampilan setelah login sukses
    renderActiveTab();
}

function updateUIStatus() {
    userLabel.innerText = isAuthorized ? "Mode: Petugas" : "Offline";
    btnLogin.innerText = isAuthorized ? "Logout" : "Login (PIN)";
    // Tombol login berfungsi jadi logout kalau sudah masuk
    btnLogin.onclick = isAuthorized ? () => { isAuthorized = false; updateUIStatus(); renderActiveTab(); } : checkPin;
}


// Tambahkan ini di fungsi logout Anda
function logout() {
  isAuthorized = false;
  userRole = null;
  document.body.classList.remove('role-user'); // Menghapus mode user
  renderActiveTab();
}

// Tambahkan event ke tombol logout jika ada di HTML
if(btnLogout) {
  btnLogout.style.display = 'block'; // Munculkan tombol logout
  btnLogout.onclick = logout;
}


window.onbeforeunload = function() {
  if (document.querySelectorAll('.input-score').some(i => i.value !== "")) {
    return "Data belum disimpan, yakin ingin keluar?";
  }
};


// Inisialisasi awal tombol login
btnLogin.onclick = checkPin;
btnLogout.style.display = 'none'; // Sembunyikan tombol logout bawaan lama
// initial render
renderActiveTab();
renderTransactionsWith(window._latestTx||[]);

</script>

</body>
</html>
